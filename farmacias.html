<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Farmacias Cercanas - C.U.R.A.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg-dark: #00345C;
      --cura-blue: #004E85;
      --accent: #00C2FF;
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    body {
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at top right, rgba(0, 78, 133, 0.5), transparent),
        radial-gradient(circle at bottom left, rgba(0, 194, 255, 0.05), transparent);
      color: white;
      margin: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }

    .app-shell {
      width: 100%;
      max-width: 414px;
      padding: 20px;
      padding-bottom: 120px;
      display: flex;
      flex-direction: column;
    }

    /* --- HEADER --- */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 5px;
      margin-bottom: 25px;
    }
    .back-btn {
      width: 40px; height: 40px; border-radius: 12px; background: var(--glass);
      border: 1px solid var(--glass-border); display: flex; align-items: center;
      justify-content: center; color: #fff; font-size: 20px; cursor: pointer;
    }

    /* --- TARJETA DE BÚSQUEDA --- */
    .search-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .location-box {
      background: rgba(0, 194, 255, 0.1);
      border: 1px solid rgba(0, 194, 255, 0.2);
      border-radius: 20px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .status-dot {
      width: 10px; height: 10px; background: var(--accent); border-radius: 50%;
      box-shadow: 0 0 10px var(--accent);
    }

    /* --- PILLS --- */
    .pill-scroll-container { width: 100%; overflow-x: auto; display: flex; padding-bottom: 5px; }
    .pill-scroll-container::-webkit-scrollbar { display: none; }
    .pill-wrapper { display: flex; gap: 10px; }
    .pill {
      flex-shrink: 0; padding: 10px 20px; background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border); border-radius: 999px;
      font-size: 12px; font-weight: 600; color: white; cursor: pointer; transition: 0.3s;
    }
    .pill.active { background: var(--accent); color: var(--bg-dark); border-color: var(--accent); }

    /* --- FARMACIA CARD --- */
    .pharmacy-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 20px;
      margin-bottom: 15px;
    }
    .ph-name { font-size: 17px; font-weight: 800; color: white; }
    .status-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 8px; text-transform: uppercase; }

    .btn-ph {
      width: 100%; padding: 14px; border-radius: 16px; font-size: 13px; font-weight: 800;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      background: var(--accent); color: var(--bg-dark); margin-top: 15px;
    }

    /* --- BOTTOM BAR --- */
    .bottom-bar {
      position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
      width: 85%; max-width: 350px;
      background: rgba(6, 93, 155, 0.7);
      backdrop-filter: blur(20px); border-radius: 30px; height: 70px;
      display: flex; align-items: center; justify-content: space-around;
      border: 1px solid var(--glass-border); z-index: 1000;
    }
    .nav-btn { color: rgba(255,255,255,0.4); font-size: 24px; background: none; border: none; cursor: pointer; }
    .nav-btn.active { color: var(--accent); }
    .center-btn { 
      width: 60px; height: 60px; background: var(--accent); color: var(--bg-dark);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 28px; font-weight: bold; margin-top: -40px; box-shadow: 0 8px 20px rgba(0, 194, 255, 0.4);
    }

    /* MODAL */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0, 52, 92, 0.4); backdrop-filter: blur(10px);
      display: none; justify-content: center; align-items: center; padding: 20px; z-index: 2000;
    }
    .modal {
      background: #ffffff; width: 100%; max-width: 360px; border-radius: 35px;
      padding: 28px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); color: #0d2b52;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="app-shell">
    <header class="header-bar">
      <button class="back-btn" onclick="history.back()"><i class="ph-bold ph-caret-left"></i></button>
      <div class="text-lg font-extrabold">Farmacias Cercanas</div>
      <div style="width:40px"></div>
    </header>

    <main>
      <div class="search-card">
        <p class="text-[10px] font-extrabold uppercase tracking-widest text-cura-accent mb-4">Búsqueda Inteligente</p>
        
        <div class="location-box">
          <div class="status-dot"></div>
          <div>
            <p id="loc-status" class="text-xs font-bold">Ubicación Actual</p>
            <p id="loc-ciudad" class="text-[11px] opacity-70">Detectando...</p>
          </div>
        </div>

        <div class="pill-scroll-container">
          <div class="pill-wrapper">
            <div class="pill active" data-filter="all">Todas</div>
            <div class="pill" data-filter="open">Abiertas ahora</div>
            <div class="pill" data-filter="guardia">Guardia 24hs</div>
          </div>
        </div>
      </div>

      <p class="text-[10px] font-extrabold uppercase tracking-widest text-cura-accent mb-4 ml-2">Resultados</p>
      
      <div id="resultsList">
        <div style="text-align: center; padding: 40px;">
          <div style="width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
      </div>
    </main>

    <nav class="bottom-bar">
      <button class="nav-btn" onclick="location.href='menu.html'"><i class="ph-bold ph-house-line"></i></button>
      <button class="nav-btn" onclick="location.href='solicitar-turno.html'"><i class="ph-bold ph-calendar-blank"></i></button>
      <div class="center-btn" onclick="abrirModalAyuda()">?</div>
      <button class="nav-btn active" onclick="location.href='farmacias.html'"><i class="ph-bold ph-pill"></i></button>
      <button class="nav-btn" onclick="location.href='perfil.html'"><i class="ph-bold ph-user-circle"></i></button>
    </nav>
  </div>

  <div id="modal-container" class="modal-backdrop" onclick="cerrarModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-extrabold">Ayuda: Farmacias</h3>
        <button onclick="cerrarModal()" class="bg-gray-100 p-2 rounded-full"><i class="ph ph-x"></i></button>
      </div>
      <div id="modal-body" class="space-y-5 text-sm text-gray-600 leading-relaxed">
        </div>
      <div class="mt-8 pt-5 border-t border-gray-100">
        <button onclick="cerrarModal()" class="flex items-center gap-2 text-cura-blue font-bold text-lg">
          <i class="ph-bold ph-arrow-left"></i> Volver
        </button>
      </div>
    </div>
  </div>

  <script>
    const resultsList = document.getElementById('resultsList');
    let allPharmacies = [];
    let currentFilter = 'all';

    function abrirModalAyuda() {
      const modal = document.getElementById('modal-container');
      const body = document.getElementById('modal-body');
      body.innerHTML = `
        <div class="flex gap-4">
          <i class="ph-bold ph-navigation-arrow text-2xl text-blue-600"></i>
          <p><strong>Cercanía:</strong> Mostramos las farmacias en un radio de 5km de tu posición actual según la Ley C.U.R.A.</p>
        </div>
        <div class="flex gap-4">
          <i class="ph-bold ph-clock text-2xl text-blue-600"></i>
          <p><strong>Estado:</strong> El indicador detecta si la farmacia está abierta ahora o si se encuentra de guardia las 24hs.</p>
        </div>
        <div class="flex gap-4">
          <i class="ph-bold ph-map-pin text-2xl text-blue-600"></i>
          <p><strong>Navegación:</strong> Al pulsar "Llegar", se abrirá automáticamente el mapa nativo de tu dispositivo.</p>
        </div>
      `;
      modal.style.display = "flex";
    }

    function cerrarModal() { document.getElementById('modal-container').style.display = "none"; }

    // --- LÓGICA DE GEOLOCALIZACIÓN Y CARGA ---
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        
        // Ciudad
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
          .then(res => res.json()).then(data => {
            const city = data.address.city || data.address.town || "Cerca tuyo";
            document.getElementById("loc-ciudad").innerText = city + ", " + (data.address.state || "Argentina");
          });

        // Farmacias (Overpass API)
        const query = `[out:json][timeout:15];node(around:5000,${lat},${lon})["amenity"="pharmacy"];out;`;
        fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`)
          .then(res => res.json()).then(data => {
            if (data.elements) {
              allPharmacies = data.elements.map(ph => ({
                ...ph,
                dist: getDist(lat, lon, ph.lat, ph.lon)
              })).sort((a,b) => a.dist - b.dist);
              renderFiltered();
            }
          });
      });
    }

    function renderFiltered() {
      let html = "";
      const now = new Date().getHours();
      let filtered = allPharmacies;

      if (currentFilter === 'open') filtered = allPharmacies.filter(f => (f.tags.opening_hours || "").includes("24/7") || (now >= 8 && now < 21));
      if (currentFilter === 'guardia') filtered = allPharmacies.filter(f => (f.tags.opening_hours || "").includes("24/7"));

      if (filtered.length === 0) {
        resultsList.innerHTML = `<p class="text-center opacity-40 text-sm py-10">No se encontraron farmacias con este filtro.</p>`;
        return;
      }

      filtered.forEach(ph => {
        const is24hs = (ph.tags.opening_hours || "").includes("24/7");
        let status = is24hs ? { label: "Guardia 24hs", class: "bg-amber-500/20 text-amber-400" } : 
                     (now < 8 || now >= 21) ? { label: "Cerrado", class: "bg-red-500/20 text-red-400" } : 
                     { label: "Abierto", class: "bg-green-500/20 text-green-400" };

        const distStr = ph.dist ? (ph.dist > 1 ? ph.dist.toFixed(1)+'km' : (ph.dist*1000).toFixed(0)+'m') : '--';
        const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${ph.lat},${ph.lon}`;

        html += `
          <article class="pharmacy-card">
            <div class="flex justify-between items-start mb-2">
              <h3 class="ph-name">${ph.tags.name || "Farmacia"}</h3>
              <span class="status-badge ${status.class}">${status.label}</span>
            </div>
            <p class="text-xs opacity-60 mb-4">${ph.tags["addr:street"] || 'Dirección disponible'} · ${distStr}</p>
            <a href="${mapUrl}" target="_blank" class="btn-ph">
              <i class="ph-bold ph-navigation-arrow"></i> LLEGAR
            </a>
          </article>`;
      });
      resultsList.innerHTML = html;
    }

    function getDist(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    document.querySelectorAll('.pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        currentFilter = pill.dataset.filter;
        renderFiltered();
      });
    });
  </script>
</body>
</html>
