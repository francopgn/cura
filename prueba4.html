<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Coze Embebido - Render Fix</title>
    <script src="https://sf-cdn.coze.com/obj/unpkg-va/flow-platform/chat-app-sdk/1.2.0-beta.10/libs/oversea/index.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        #main-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #chat-wrapper {
            width: 100%;
            height: 600px;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
            background: white;
        }
        
        #coze-chat-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .status-container {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-loading { background: #e3f2fd; color: #1565c0; }
        .status-success { background: #e8f5e9; color: #2e7d32; }
        .status-error { background: #ffebee; color: #c62828; }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #357ae8;
        }
        
        #dom-check {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <h1>üîß Chat Coze - Debug de Renderizado</h1>
        
        <div id="status" class="status-container status-loading">
            <div class="spinner"></div>
            <span>Inicializando...</span>
        </div>
        
        <div class="controls">
            <button onclick="forceRender()">üîÑ Forzar Render</button>
            <button onclick="checkDOM()">üîç Verificar DOM</button>
            <button onclick="showChat()">üëÅÔ∏è Mostrar Chat</button>
            <button onclick="hideChat()">üëÅÔ∏è Ocultar Chat</button>
            <button onclick="reloadSDK()">üì¶ Recargar SDK</button>
        </div>
        
        <!-- Contenedor PRINCIPAL del chat -->
        <div id="chat-wrapper">
            <div id="coze-container" style="width:100%; height:100%;">
                <!-- El SDK inyectar√° el chat aqu√≠ -->
            </div>
        </div>
        
        <div id="dom-check" style="display:none;">
            <!-- Aqu√≠ se mostrar√° el estado del DOM -->
        </div>
    </div>

    <script>
        let cozeClient = null;
        let containerId = 'coze-' + Date.now();
        
        // Funci√≥n para actualizar estado
        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `
                <div class="spinner" style="${type !== 'loading' ? 'display:none;' : ''}"></div>
                <span>${message}</span>
            `;
            statusEl.className = `status-container status-${type}`;
        }
        
        // Funci√≥n para verificar el DOM
        function checkDOM() {
            const container = document.getElementById(containerId) || document.getElementById('coze-container');
            const domCheck = document.getElementById('dom-check');
            
            let html = '=== VERIFICACI√ìN DOM ===\n\n';
            
            if (container) {
                html += `‚úÖ Contenedor encontrado: ${container.id}\n`;
                html += `Dimensiones: ${container.offsetWidth}x${container.offsetHeight}px\n`;
                html += `Hijos: ${container.children.length}\n\n`;
                html += 'Contenido HTML:\n';
                html += container.innerHTML.substring(0, 500) + '...';
            } else {
                html += '‚ùå Contenedor no encontrado\n';
            }
            
            // Verificar si hay iframes
            const iframes = document.querySelectorAll('iframe');
            html += `\n\n=== IFRAMES (${iframes.length}) ===\n`;
            iframes.forEach((iframe, i) => {
                html += `Iframe ${i}: ${iframe.src ? iframe.src.substring(0, 50) + '...' : 'sin src'}\n`;
            });
            
            domCheck.textContent = html;
            domCheck.style.display = 'block';
        }
        
        // Funci√≥n para obtener token
        async function getToken() {
            try {
                const response = await fetch('/api/coze-token');
                const data = await response.json();
                return data.token || data.access_token;
            } catch (error) {
                console.error('Error obteniendo token:', error);
                // Para pruebas, usar un token dummy (reemplaza con uno real)
                return 'dummy_token_for_testing_' + Date.now();
            }
        }
        
        // Funci√≥n principal para inicializar el chat
        async function initializeChat() {
            try {
                updateStatus('Obteniendo token...', 'loading');
                const token = await getToken();
                
                // Crear contenedor limpio
                const container = document.getElementById('coze-container');
                container.innerHTML = `<div id="${containerId}" style="width:100%; height:100%;"></div>`;
                
                updateStatus('Inicializando SDK...', 'loading');
                
                // OPCI√ìN A: Usar WebChatClient
                cozeClient = new CozeWebSDK.WebChatClient({
                    config: {
                        bot_id: '7596429833782214709',
                        container: `#${containerId}`,
                        position: 'embedded',
                        auto_open: true,
                        layout: 'standard',
                        enableTool: true,
                        showCloseButton: false,
                        isIframe: false // Probar tanto true como false
                    },
                    auth: {
                        type: "token",
                        token: token,
                        onRefreshToken: getToken
                    },
                    userInfo: {
                        id: 'user_' + Math.random().toString(36).substr(2, 9),
                        nickname: 'Usuario Web'
                    },
                    ui: {
                        base: { 
                            layout: 'pc', 
                            lang: 'es',
                            zIndex: 1000
                        },
                        asstBtn: { 
                            isNeed: false 
                        },
                        footer: { 
                            isShow: false 
                        },
                        chatBot: { 
                            title: 'ü§ñ Asistente Virtual',
                            width: '100%',
                            height: '100%',
                            showHeader: true,
                            background: '#ffffff'
                        }
                    },
                    events: {
                        onLoad: function() {
                            console.log('‚úÖ Evento onLoad disparado');
                            updateStatus('Chat cargado correctamente', 'success');
                            
                            // Forzar visibilidad despu√©s de cargar
                            setTimeout(() => {
                                const chatContainer = document.querySelector(`#${containerId} iframe`);
                                if (chatContainer) {
                                    chatContainer.style.visibility = 'visible';
                                    chatContainer.style.opacity = '1';
                                }
                                checkDOM(); // Verificar estado
                            }, 500);
                        },
                        onError: function(error) {
                            console.error('‚ùå Error en chat:', error);
                            updateStatus(`Error: ${error.message}`, 'error');
                        },
                        onMessage: function(message) {
                            console.log('Mensaje:', message);
                        }
                    }
                });
                
                // Verificar despu√©s de 3 segundos
                setTimeout(() => {
                    const chatContainer = document.querySelector(`#${containerId}`);
                    if (chatContainer && chatContainer.children.length === 0) {
                        console.log('Contenedor vac√≠o, probando m√©todo alternativo...');
                        tryAlternativeMethod();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error inicializando chat:', error);
                updateStatus(`Error: ${error.message}`, 'error');
                
                // Intentar m√©todo alternativo
                tryAlternativeMethod();
            }
        }
        
        // M√©todo alternativo si WebChatClient no funciona
        function tryAlternativeMethod() {
            updateStatus('Probando m√©todo alternativo...', 'loading');
            
            // Limpiar contenedor
            const container = document.getElementById('coze-container');
            container.innerHTML = `<iframe 
                id="coze-iframe"
                src="about:blank"
                style="width:100%; height:100%; border:none;"
                allow="microphone"
            ></iframe>`;
            
            // Crear iframe manualmente
            const iframe = document.getElementById('coze-iframe');
            iframe.src = `https://www.coze.com/embed/7596429833782214709`;
            
            iframe.onload = () => {
                updateStatus('Iframe cargado manualmente', 'success');
            };
            
            iframe.onerror = () => {
                updateStatus('Error cargando iframe', 'error');
            };
        }
        
        // Funci√≥n para forzar renderizado
        function forceRender() {
            if (cozeClient && cozeClient.show) {
                cozeClient.show();
                updateStatus('Forzando visualizaci√≥n...', 'loading');
                
                // Aplicar estilos para asegurar visibilidad
                const container = document.querySelector(`#${containerId}`);
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.opacity = '1';
                    container.style.width = '100%';
                    container.style.height = '100%';
                }
                
                setTimeout(checkDOM, 500);
            }
        }
        
        // Funci√≥n para mostrar/ocultar chat
        function showChat() {
            const wrapper = document.getElementById('chat-wrapper');
            wrapper.style.display = 'block';
            forceRender();
        }
        
        function hideChat() {
            document.getElementById('chat-wrapper').style.display = 'none';
        }
        
        // Funci√≥n para recargar SDK
        function reloadSDK() {
            updateStatus('Recargando...', 'loading');
            location.reload();
        }
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Peque√±o delay para asegurar que el SDK est√° cargado
            setTimeout(() => {
                if (window.CozeWebSDK) {
                    initializeChat();
                } else {
                    updateStatus('‚ùå SDK no cargado', 'error');
                }
            }, 100);
        });
    </script>
</body>
</html>
