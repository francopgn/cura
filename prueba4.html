<!DOCTYPE html>
<html>
<head>
    <title>Chat Coze - Solución Iframe</title>
    <style>
        #chat-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>Chat Coze via Iframe</h1>
    
    <!-- Este método es más confiable cuando el SDK tiene problemas -->
    <iframe 
        id="chat-frame"
        src="about:blank"
        allow="microphone; clipboard-write"
    ></iframe>
    
    <script>
        async function getCozeEmbedUrl() {
            try {
                // Obtener token
                const tokenRes = await fetch('/api/coze-token');
                const tokenData = await tokenRes.json();
                const token = tokenData.token || tokenData.access_token;
                
                // Construir URL con token
                const botId = '7596429833782214709';
                return `https://www.coze.com/embed/${botId}?token=${encodeURIComponent(token)}`;
                
            } catch (error) {
                console.error('Error:', error);
                // URL sin token (puede no funcionar si requiere auth)
                return 'https://www.coze.com/embed/7596429833782214709';
            }
        }
        
        async function loadChat() {
            const iframe = document.getElementById('chat-frame');
            const embedUrl = await getCozeEmbedUrl();
            
            console.log('Cargando:', embedUrl);
            iframe.src = embedUrl;
            
            // Verificar carga
            iframe.onload = () => {
                console.log('✅ Iframe cargado');
                // Intentar comunicar con el iframe
                try {
                    iframe.contentWindow.postMessage({
                        type: 'coze-init',
                        token: 'from-parent'
                    }, '*');
                } catch (e) {}
            };
            
            iframe.onerror = () => {
                console.error('❌ Error cargando iframe');
                iframe.srcdoc = `
                    <html>
                        <body style="padding:20px; font-family:Arial;">
                            <h3>Error cargando chat</h3>
                            <p>URL intentada: ${embedUrl}</p>
                            <p>Posibles soluciones:</p>
                            <ol>
                                <li>Verificar que el bot existe y es público</li>
                                <li>Verificar permisos de autenticación</li>
                                <li>Contactar al administrador</li>
                            </ol>
                        </body>
                    </html>
                `;
            };
        }
        
        // Escuchar mensajes del iframe
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'coze-ready') {
                console.log('Chat listo dentro del iframe');
            }
        });
        
        // Cargar cuando la página esté lista
        window.onload = loadChat;
    </script>
</body>
</html>
