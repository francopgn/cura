<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Farmacias Cercanas - C.U.R.A.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --main-bg: #f0f4f8; 
      --blue-header: #005fa3; 
      --blue-main: #1f6fe5;
      --blue-soft: #e3f0ff;
      --text-dark: #0d2b52;
      --text-gray: #64748b;
      --card-white: #ffffff;
      --border-soft: #e5e7eb;
      --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.05);
      --green-status: #16a34a;
    }

    html {
      overflow-y: scroll;
      scrollbar-width: none; 
    }
    ::-webkit-scrollbar { display: none; }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
    
    body { 
      background-color: var(--main-bg); 
      display: flex; 
      justify-content: center; 
      min-height: 100vh; 
      overflow-x: hidden; 
    }

    .app-shell { 
      width: 100%; 
      max-width: 414px; 
      display: flex; 
      flex-direction: column; 
      padding-bottom: 120px; 
    }

    .header-bar {
      background-color: var(--blue-header);
      width: calc(100% - 40px);
      margin: 20px auto 10px; 
      height: 60px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 8px 20px rgba(0, 95, 163, 0.2);
      justify-content: space-between;
      z-index: 100;
    }

    .back-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.2);
      display: flex; align-items: center; justify-content: center; color: #fff; font-size: 22px; border: none; cursor: pointer;
    }
    .header-title { color: #ffffff; font-size: 18px; font-weight: 700; }
    .header-spacer { width: 36px; height: 36px; }

    .main-content { padding: 10px 20px; }
    .card { background: var(--card-white); border-radius: 28px; padding: 24px; box-shadow: var(--shadow-soft); margin-bottom: 20px; }
    .section-label { font-size: 13px; font-weight: 800; color: var(--blue-header); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; display: block; }

    .search-input {
      width: 100%; padding: 14px 18px; border-radius: 16px; border: 1px solid var(--border-soft);
      background: #f8fafc; font-size: 14px; margin-bottom: 15px; outline: none;
    }

    .pill-container-relative { position: relative; width: 100%; }
    .fade-edge {
      position: absolute; top: 0; bottom: 0; width: 40px; z-index: 2;
      pointer-events: none; transition: opacity 0.3s ease; opacity: 0;
    }
    .fade-left { left: 0; background: linear-gradient(to right, white, transparent); }
    .fade-right { right: 0; background: linear-gradient(to left, white, transparent); opacity: 1; }

    .pill-scroll-container {
      width: 100%; overflow-x: auto; display: flex; padding-bottom: 10px;
      -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; scroll-behavior: smooth;
    }
    .pill-scroll-container::-webkit-scrollbar { display: none; }
    .pill-wrapper { display: flex; gap: 10px; flex-wrap: nowrap; }

    .pill {
      flex-shrink: 0; scroll-snap-align: start; padding: 10px 18px; background: #fff;
      border: 1.5px solid var(--border-soft); border-radius: 999px; font-size: 12px;
      font-weight: 600; color: var(--text-gray); white-space: nowrap; cursor: pointer;
    }
    .pill.active { background: var(--blue-main); color: #fff; border-color: var(--blue-main); box-shadow: 0 4px 10px rgba(31, 111, 229, 0.2); }

    .nav-arrow {
      position: absolute; top: 50%; transform: translateY(-50%); width: 28px; height: 28px;
      background: var(--blue-main); color: white; border-radius: 50%; border: none;
      z-index: 10; display: flex; align-items: center; justify-content: center;
      cursor: pointer; opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .pill-container-relative:hover .nav-arrow { opacity: 1; }
    .nav-arrow.left { left: -10px; }
    .nav-arrow.right { right: -10px; }

    .pharmacy-card { border: 1px solid var(--border-soft); border-radius: 22px; padding: 18px; margin-bottom: 12px; }
    .ph-name { font-size: 16px; font-weight: 700; color: var(--text-dark); }
    .status-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 8px; text-transform: uppercase; }
    .status-open { background: #dcfce7; color: #166534; }
    
    .ph-actions { display: flex; gap: 10px; margin-top: 15px; }
    
    .btn-ph { 
      flex: 1; padding: 12px 0; border-radius: 14px; font-size: 11px; font-weight: 800; 
      text-decoration: none; text-transform: uppercase; display: flex; align-items: center;
      justify-content: center; gap: 6px; 
    }
    .btn-map { background: var(--blue-main); color: #fff; }
    .btn-detail { background: #f1f5f9; color: var(--text-dark); }

    .bottom-bar {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); width: 90%;
      max-width: 360px; background: #ffffff; border-radius: 35px; height: 70px;
      display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1); z-index: 1000;
    }
    .nav-icon-btn { background: none; border: none; padding: 10px; cursor: pointer; color: var(--text-gray); transition: all 0.2s; }
    .nav-icon-btn.active { color: var(--blue-main); }
    .nav-icon-btn i { font-size: 26px; }
    .center-question-btn { width: 64px; height: 64px; background: var(--blue-main); border-radius: 50%; border: 5px solid var(--main-bg); display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: 600; margin-top: -35px; box-shadow: 0 8px 20px rgba(31, 111, 229, 0.3); }
    .nav-icon-btn:active, .center-question-btn:active { transform: scale(0.9); }
  </style>
</head>
<body>

  <div class="app-shell">
    <header class="header-bar">
      <button class="back-btn" onclick="history.back()"><i class="ph ph-caret-left"></i></button>
      <div class="header-title">Farmacias Cercanas</div>
      <div class="header-spacer"></div>
    </header>

    <main class="main-content">
      <div class="card">
        <span class="section-label">Búsqueda Inteligente</span>
        <div style="background: var(--blue-soft); border-radius: 20px; padding: 15px; display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
          <div style="width: 10px; height: 10px; background: var(--green-status); border-radius: 50%; box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.2);"></div>
          <div>
            <p id="loc-status" style="font-size: 13px; font-weight: 700; color: var(--text-dark);">Ubicación Actual</p>
            <p id="loc-ciudad" style="font-size: 11px; color: var(--text-gray);">Detectando ciudad...</p>
          </div>
        </div>

        <input type="text" class="search-input" id="mainSearch" placeholder="Nombre o dirección...">
        
        <div class="pill-container-relative">
          <div id="fadeLeft" class="fade-edge fade-left"></div>
          <div id="fadeRight" class="fade-edge fade-right"></div>
          <button class="nav-arrow left" onclick="scrollPills(-120)"><i class="ph-bold ph-caret-left"></i></button>
          <div class="pill-scroll-container" id="pillScroll">
            <div class="pill-wrapper">
              <div class="pill active">Cerca de mí</div>
              <div class="pill">Abiertas ahora</div>
              <div class="pill">PAMI</div>
              <div class="pill">IOMA</div>
            </div>
          </div>
          <button class="nav-arrow right" onclick="scrollPills(120)"><i class="ph-bold ph-caret-right"></i></button>
        </div>
      </div>

      <div class="card">
        <span class="section-label">Resultados</span>
        <div id="resultsList">
          <p style="font-size: 13px; color: var(--text-gray); text-align: center; padding: 20px;">Buscando farmacias reales...</p>
        </div>
      </div>
    </main>

    <nav class="bottom-bar">
      <button class="nav-icon-btn" onclick="location.href='menu.html'"><i class="ph-bold ph-house"></i></button>
      <button class="nav-icon-btn" onclick="location.href='solicitar-turno.html'"><i class="ph-bold ph-calendar-blank"></i></button>
      <div class="center-question-btn" onclick="location.href='asistente.html'">?</div>
      <button class="nav-icon-btn active" onclick="location.href='farmacias.html'"><i class="ph-bold ph-prescription"></i></button>
      <button class="nav-icon-btn" onclick="location.href='perfil.html'"><i class="ph-bold ph-user"></i></button>
    </nav>
  </div>

  <script>
    const scrollContainer = document.getElementById('pillScroll');
    const fadeLeft = document.getElementById('fadeLeft');
    const fadeRight = document.getElementById('fadeRight');
    const resultsList = document.getElementById('resultsList');

    function updateFades() {
      const scrollLeft = scrollContainer.scrollLeft;
      const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
      fadeLeft.style.opacity = scrollLeft > 5 ? "1" : "0";
      fadeRight.style.opacity = scrollLeft < maxScroll - 5 ? "1" : "0";
    }

    scrollContainer.addEventListener('scroll', updateFades);
    window.addEventListener('resize', updateFades);
    function scrollPills(amount) { scrollContainer.scrollBy({ left: amount, behavior: 'smooth' }); }

    // --- LÓGICA DE FARMACIAS REALES (OVERPASS API) ---
    async function fetchRealPharmacies(lat, lon) {
      // Query de Overpass para buscar farmacias en 5000 metros a la redonda
      const query = `[out:json];node(around:5000,${lat},${lon})["amenity"="pharmacy"];out;`;
      const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        renderPharmacies(data.elements, lat, lon);
      } catch (error) {
        resultsList.innerHTML = `<p style="color:red; font-size:12px; text-align:center;">Error al conectar con la red federal de farmacias.</p>`;
      }
    }

    // Calcula distancia lineal simple para mostrar en metros/km
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radio de la tierra en km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c;
      return d > 1 ? `${d.toFixed(1)}km` : `${(d * 1000).toFixed(0)}m`;
    }

    function renderPharmacies(pharmacies, userLat, userLon) {
      if (pharmacies.length === 0) {
        resultsList.innerHTML = `<p style="text-align:center; font-size:13px; color:var(--text-gray);">No se encontraron farmacias cerca de tu posición.</p>`;
        return;
      }

      resultsList.innerHTML = ""; // Limpiar cargando
      
      pharmacies.forEach(ph => {
        const name = ph.tags.name || "Farmacia sin nombre";
        const address = ph.tags["addr:street"] ? `${ph.tags["addr:street"]} ${ph.tags["addr:housenumber"] || ""}` : "Dirección no disponible";
        const dist = calculateDistance(userLat, userLon, ph.lat, ph.lon);
        
        const card = document.createElement('article');
        card.className = "pharmacy-card";
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h3 class="ph-name">${name}</h3>
            <span class="status-badge status-open">Disponible</span>
          </div>
          <p class="text-[13px] text-gray-500 mb-4">${address} · ${dist}</p>
          <div class="ph-actions">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${ph.lat},${ph.lon}" target="_blank" class="btn-ph btn-map">
              <i class="ph ph-navigation-arrow"></i>LLEGAR
            </a>
            <a href="#" class="btn-ph btn-detail">DETALLES</a>
          </div>
        `;
        resultsList.appendChild(card);
      });
    }

    window.onload = () => {
      updateFades();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          
          // 1. Obtener ciudad real (Nominatim)
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await res.json();
            document.getElementById("loc-ciudad").innerText = (data.address.city || data.address.town || data.address.suburb || "Cerca tuyo") + ", " + (data.address.state || "Argentina");
          } catch(e) { document.getElementById("loc-ciudad").innerText = "Ubicación detectada"; }

          // 2. Buscar farmacias reales
          fetchRealPharmacies(lat, lon);
        });
      }
    };

    // Estética de los filtros
    document.querySelectorAll('.pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        pill.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      });
    });
  </script>
</body>
</html>
